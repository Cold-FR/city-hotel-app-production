<!DOCTYPE html>
<html>
<head>
    <title>City</title>
    <link rel="stylesheet" type="text/css" href="assets/styles/app.css">
    <link rel="stylesheet" type="text/css" href="assets/styles/updater.css">
    <link rel="stylesheet" type="text/css" href="assets/styles/buttons.css">
    <link rel="stylesheet" type="text/css" href="assets/styles/alert.css">
</head>
<body>
<div id="alert" class="alert">
    <div class="box">
        <div id="title" class="title">Attention...</div>
        <div id="description" class="description">Tu souhaites vider ton cache et relancer l'application.</div>
        <input id="input" placeholder="Mon text"/>
        <div class="btns">
            <div id="cancel" class="button" style="float:left;background: #ed1c24;">
                <div class="alpha"></div>
                Annuler
            </div>
            <div id="confirm" class="button">
                <div class="alpha"></div>
                Confirmer
            </div>
            </form>
        </div>
    </div>
</div>
<div id="updater" class="updater">
    <div class="body">
        <div class="connection">
            connexion en cours
        </div>
        <div id="progression" class="progression">
            ...
        </div>
        <div class="duck"></div>
        <div class="loader"></div>
    </div>
    <div class="logo"></div>
    <div id="version" class="version">...</div>
</div>
<iframe id="frame" width="100%" src="https://www.habbocity.me/profil"></iframe>
<div class="buttons">
    <div id="close">
        <div id="close-button" style="transform: scaleX(-1);"></div>
    </div>
    <!--
    <div id="screen" class="button">
        <div class="icon screen"></div>
        <div class="tooltip">
            <div class="arrow"></div>
            Plein écran
        </div>
    </div>
    -->
    <div id="cache" class="button">
        <div class="icon cache"></div>
        <div class="tooltip">
            <div class="arrow"></div>
            Vider le cache
        </div>
    </div>
    <div id="zoomOut" class="button">
        <div class="icon out"></div>
        <div class="tooltip">
            <div class="arrow"></div>
            Zoom -1%
        </div>
    </div>
    <div id="zoomIn" class="button">
        <div class="icon in"></div>
        <div class="tooltip">
            <div class="arrow"></div>
            Zoom +1%
        </div>
    </div>
    <div id="reload" class="button">
        <div class="icon reload"></div>
        <div class="tooltip">
            Recharger
        </div>
    </div>
    <div id="toggleRpc" class="button" style="margin-bottom: 6px">
        <div class="icon rpc"></div>
        <div class="tooltip">
            Activer / Désactiver la Rich Presence Discord
        </div>
    </div>
</div>
<div id="messages"></div>
<script>
    let ipcRenderer = window.ipcRenderer;
    let updater = document.getElementById("updater");
    let progression = document.getElementById("progression");
    let version = document.getElementById("version");

    ipcRenderer.on("version", (event, data) => {
        version.innerHTML = data;
    });
    ipcRenderer.on("checking-for-update", (event, data) => {
        progression.innerHTML = "mise à jour...";
        updater.style.display = "block";
    });
    ipcRenderer.on("update-not-available", (event, data) => {
        updater.style.display = "none";
        updater.innerHTML = "";
    });
    ipcRenderer.on("download-progress", (event, data) => {
        progression.innerHTML = Math.round(data['percent']) + "%";
    });


    let isOpenButtons = true;
    let zoomIn = document.getElementById("zoomIn");
    let zoomOut = document.getElementById("zoomOut");
    let iframe = document.getElementById("frame").contentWindow;
    let reload = document.getElementById("reload");
    let close = document.getElementById("close");
    let cache = document.getElementById("cache");
    let alert = document.getElementById("alert");
    let cancel = document.getElementById("cancel");
    let confirm = document.getElementById("confirm");
    let form = document.getElementById('form');
    let input = document.getElementById('input');

    let fullScreenFunction = () => {
        if (iframe.location.href === 'https://www.habbocity.me/hotel' && iframe.document.getElementById('hotel1')) {
            iframe.document.getElementById('hotel1').addEventListener('click', () => {
                ipcRenderer.send("fullscreen", "");
            });
            clearInterval(fullScreenInterval);
        }
    };
    let fullScreenInterval = setInterval(fullScreenFunction, 1000);


    let openAlert = (t, d, i, ipc, next) => {
        let title = document.getElementById("title");
        let description = document.getElementById("description");
        alert.style.visibility = "visible";
        title.innerText = t;
        description.innerHTML = d;

        if (i) {
            input.style.visibility = "visible";
        } else {
            input.style.visibility = "hidden";
        }

        if (ipc) {
            confirm.setAttribute('onClick', 'ipcRenderer.send("' + ipc + '", "");\n');
            if (next) {
                confirm.setAttribute('onClick', 'ipcRenderer.send("' + ipc + '", "");' + next + '\n');
            }
        }
    }
    let closeAlert = () => {
        alert.style.visibility = "hidden";
        input.style.visibility = "hidden";
        input.value = '';
    }

    let formSubmit = (event, type) => {
        event = event || window.event;
        event.preventDefault();
        iframe.document.execCommand(type, false, input.value);
        const selection = iframe.document.getSelection();
        selection.anchorNode.parentElement.target = '_blank';
        input.value = '';
    }
    let forumSendImage = () => {
        if (iframe.location.pathname.startsWith('/forum/')) {
            const link = iframe.document.querySelectorAll('#articlescombbcode')[3];
            const img = iframe.document.querySelectorAll('#articlescombbcode')[4];
            if (link && img) {
                if (link.outerHTML !== '<button id="articlescombbcode" type="button" onclick="">Lien</button>' && img.outerHTML !== '<button id="articlescombbcode" type="button" onclick="">Image</button>') {
                    link.setAttribute("onClick", "");
                    img.setAttribute("onClick", "");
                    link.addEventListener('click', () => {
                        openAlert("Forum - Lien", "Entre le lien que tu souhaites insérer dans le champ ci-dessous.", true);
                        form.setAttribute("onSubmit", "formSubmit(event, 'createLink')");
                    });
                    img.addEventListener('click', () => {
                        openAlert("Forum - Image", "Entre l'adresse de l'image que tu souhaites insérer dans le champ ci-dessous.", true);
                        form.setAttribute("onSubmit", "formSubmit(event, 'insertImage')");
                    });
                }
            }
        }
    }
    let forumSendImageInterval = setInterval(forumSendImage, 1000);

    zoomIn.addEventListener('click', () => {
        ipcRenderer.send("zoomIn", "");
    });
    zoomOut.addEventListener('click', () => {
        ipcRenderer.send("zoomOut", "");
    });
    reload.addEventListener('click', () => {
        iframe.location.reload();
        fullScreenInterval = setInterval(fullScreenFunction, 1000);
    });
    close.addEventListener('click', () => {
        if (!isOpenButtons) {
            isOpenButtons = true;
            document.querySelector('.buttons').style.width = "50px";
            document.getElementById('close-button').style.transform = "scaleX(-1)";
        } else {
            isOpenButtons = false;
            document.querySelector('.buttons').style.width = "0px";
            document.getElementById('close-button').style.transform = "none";
        }
    });
    cache.addEventListener('click', () => {
        openAlert("Attention...", "Tu souhaites vider ton cache et relancer l'application.", false, "clearcache");
    });
    cancel.addEventListener('click', () => {
        closeAlert();
    });
    confirm.addEventListener('click', () => {
        closeAlert();
    });

    function discordRpc() {
        if (iframe) {
            let iframeData = {
                pathname: iframe.location.pathname.replace('.php', ''),
                title: iframe.document.title,
                elements: []
            };

            if (iframeData.pathname.toLowerCase() === '/register') {
                if (iframe.document.getElementById('registerusername')) iframeData.elements.push(iframe.document.getElementById('registerusername').value);
            }

            if (iframeData.pathname.toLowerCase().startsWith('/profil/')) {
                if (iframe.document.getElementById('profil87')) iframeData.elements.push(iframe.document.getElementById('profil87').style.display);

                if (iframe.document.getElementById('profil121')) iframeData.elements.push(iframe.document.getElementById('profil121').innerText);
            }

            if (iframeData.pathname.toLowerCase() === '/meet') {
                if (iframe.document.getElementById('meetSearch')) iframeData.elements.push(iframe.document.getElementById('meetSearch').value);
            }

            if (iframeData.pathname.toLowerCase() === '/news') {
                if (iframe.document.getElementById('search1')) iframeData.elements.push(iframe.document.getElementById('search1').style.display);

                if (iframe.document.getElementById('search3')) iframeData.elements.push(iframe.document.getElementById('search3').value);
            }

            if (iframeData.pathname.toLowerCase() === '/community/fansites') {
                if (iframe.document.getElementById('f37')) iframeData.elements.push(iframe.document.getElementById('f37').style.display);

                if (iframe.document.querySelector('.sfdnom')) iframeData.elements.push(iframe.document.querySelector('.sfdnom').value);
            }

            /*if (iframeData.pathname.toLowerCase() === '/community/fansites/new') {
                if (iframe.document.getElementById('arttitre')) iframeData.elements.push(iframe.document.getElementById('arttitre').value);
            }*/

            if (iframeData.pathname.toLowerCase() === '/forum') {
                if (iframe.document.getElementById('search1')) iframeData.elements.push(iframe.document.getElementById('search1').style.display);

                if (iframe.document.getElementById('search3')) iframeData.elements.push(iframe.document.getElementById('search3').value);
            }

            if (iframeData.pathname.toLowerCase() === '/forum/new-sujet') {
                if (iframe.document.getElementById('topictitl')) iframeData.elements.push(iframe.document.getElementById('topictitl').value);

                if (iframe.document.getElementById('topiccategory')) iframeData.elements.push(iframe.document.getElementById('topiccategory').value);
            }

            if (iframeData.pathname.toLowerCase() === '/boutique/coffres') {
                if (iframe.document.getElementById('boutiqueload')) iframeData.elements.push(iframe.document.getElementById('boutiqueload').style.display);

                if (iframe.document.getElementById('b168')) iframeData.elements.push('b168');
            }

            if (iframeData.pathname.toLowerCase() === '/settings') {
                if (iframe.document.getElementById('settings16')) iframeData.elements.push(iframe.document.getElementById('settings16').style.display);

                if (iframe.document.getElementById('settings38')) iframeData.elements.push(iframe.document.getElementById('settings38').innerText);

                if (iframe.document.getElementById('settings20')) iframeData.elements.push(iframe.document.getElementById('settings20').innerText);
            }

            if (iframe.document.getElementById('cityclub') && iframe.document.getElementById('cityclub').style.display === 'block') {
                iframeData.cityclub = true;
            }

            if (iframeData.pathname.toLowerCase().startsWith('/boutique')) {
                if (iframe.document.getElementById('boutiqueload')) iframeData.elements.push(iframe.document.getElementById('boutiqueload').style.display);

                ///if (iframe.document.getElementById('b101')) iframeData.elements.push(iframe.document.getElementById('b101').value);

                if (iframe.document.getElementById('b280')) iframeData.elements.push('b280');

                /*if (iframe.document.getElementById('b104x')) iframeData.elements.push('b104x');

                if (iframe.document.getElementById('b104')) iframeData.elements.push('b104');

                if (iframe.document.getElementById('b106')) {
                    iframeData.elements.push('b106');
                    iframeData.elements.push(iframe.document.getElementById('b106').style.display);

                    if (iframe.document.getElementById('b110nom')) iframeData.elements.push(iframe.document.getElementById('b110nom').innerText);

                    if (iframe.document.getElementById('b109')) iframeData.elements.push(iframe.document.getElementById('b109').src.replace("https://swf.habbocity.me/c_images/album1584/", ""));
                }

                if (iframe.document.getElementById('b201')) iframeData.elements.push('b201');

                if (iframe.document.getElementById('b208')) iframeData.elements.push('b208');

                if (iframe.document.getElementById('b210')) {
                    iframeData.elements.push('b210');
                    iframeData.elements.push(iframe.document.getElementById('b210').style.display);

                    if (iframe.document.getElementById('b215')) iframeData.elements.push(iframe.document.getElementById('b215').innerText);

                    if (iframe.document.getElementById('b219')) iframeData.elements.push(iframe.document.getElementById('b219').value);
                }*/
            }

            if (iframe.document.getElementById('fil1') && iframe.document.getElementById('fil1').style.right === '0px') {
                iframeData.fil = true;
                iframeData.elements.push(iframe.document.getElementById('fil1').style.right);

                if (iframe.document.getElementById('fil36')) {
                    iframeData.elements.push('fil36');
                    iframeData.elements.push(iframe.document.getElementById('fil36').parentNode.id);
                }

                if (iframe.document.getElementById('fil25')) {
                    iframeData.elements.push('fil25');
                    iframeData.elements.push(iframe.document.getElementById('fil25').value);
                }
            }

            if (iframe.document.getElementById('rydHSG45s') && iframe.document.getElementById('rydHSG45s').style.display === 'block') {
                iframeData.story = true;
                iframeData.elements.push(iframe.document.getElementById('rydHSG45s').style.display);

                if (iframe.document.getElementById('str4')) iframeData.elements.push(iframe.document.getElementById('str4').innerText);
            }

            if (iframe.document.getElementById('rydHSG45si') && iframe.document.getElementById('rydHSG45si').style.display === 'block') {
                iframeData.photos = true;
                iframeData.elements = [];
                iframeData.elements.push(iframe.document.getElementById('rydHSG45si').style.display);

                if (iframe.document.getElementById('str46')) {
                    if (iframe.document.querySelectorAll('#str46')[1].parentElement.style.transform === 'scale(1)') {
                        iframeData.elements.push(iframe.document.querySelectorAll('#str46')[1].innerText);
                    }
                }
            }

            if (iframe.document.getElementById('Parrainage') && iframe.document.getElementById('Parrainage').style.display === 'block') {
                iframeData.sponso = true;
                iframeData.elements.push(iframe.document.getElementById('Parrainage').style.display);

                if (iframe.document.getElementById('Parrainage-Link')) iframeData.elements.push(iframe.document.getElementById('Parrainage-Link').value);
            }

            if (iframe.document.getElementById('ai1') && iframe.document.getElementById('ai1').style.display === 'block') {
                iframeData.helpcenter = true;
                iframeData.elements.push(iframe.document.getElementById('ai1').style.display);

                if (iframe.document.getElementById('ai5')) iframeData.elements.push(iframe.document.getElementById('ai5').innerText);
            }

            if (updater.style.display === 'block') {
                iframeData.update = true;
            }

            ipcRenderer.send('updateRpc', iframeData);
            iframeData = {};
        }
    }

    const checkRpc = setInterval(discordRpc, 5000);
    const toggleRpc = document.getElementById("toggleRpc");

    toggleRpc.addEventListener('click', () => {
        openAlert("Attention...", "Tu souhaites activer ou désactiver la Rich Presence Discord. <br/><i>(Tu devras activer l'affichage de jeu dans tes paramètres Discord.)</i>", false, "toggleRpc", "discordRpc();");
    });

</script>
</body>
</html>